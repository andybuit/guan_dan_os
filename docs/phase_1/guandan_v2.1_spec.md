# 掼蛋游戏 - 核心流程与界面设计需求文档 (v2.1 生产级)

**文档版本**: v2.1 (AI机器人、座位分配、房间自动填补 - 生产级详细)  
**更新日期**: 2025年12月13日  
**适用平台**: Web + 手机版 (iOS/Android)  
**设计范围**: 座位系统、AI机器人、房间流程、游戏进行、结算

---

## 第1部分: 座位系统与加入机制

### 1.1 座位方向定义 (绝对标准)

```
【 座位方向 - 永远以玩家视角 】

        北 (North)
        玩家B (对家)
          ▲
          │
西 ◄─────┼─────► 东
玩家C    │     玩家A
(对手)   │     (对手)
         │
    南 (South)
    玩家D (你)
    ↑ 本人永远坐这里

队伍分配:
  同盟 (我们队):
    └─ 玩家D (你) + 玩家B (北方) = 2人
  
  敌方 (对方队):
    └─ 玩家A (东方) + 玩家C (西方) = 2人
```

**核心原则**:
- ✅ 玩家自己永远坐在**南方(下方)**
- ✅ 对家永远在**北方(上方)** → 队友
- ✅ 对手在**西方(左方)** 和 **东方(右方)**
- ✅ 这是绝对不变的视角规则
- ✅ 所有界面都遵循此规则

### 1.2 玩家加入顺序与座位分配

```
【 房间创建到满人的完整流程 】

时间点        事件                  座位分配        倒计时状态
───────────────────────────────────────────────────────────
T0:00s    房主创建房间
          房主自动坐下
                                  南 (你)         创建倒计时
                                  北/西/东 空闲    10秒开始

T0:05s    玩家1点击加入
          系统分配座位
                                  北 玩家1         倒计时重置
                                  西/东 空闲       10秒重新开始

T0:10s    玩家2点击加入
          系统分配座位
                                  西 玩家2         倒计时重置
                                  东 空闲          10秒重新开始

T0:15s    【 倒计时: 10秒监控开始 】
          东方座位开始计时
                                  东 空闲 ⏱10s    计数中...
          
T0:20s    倒计时还剩5秒
          东方仍无玩家加入
                                  东 空闲 ⏱5s     警告状态

T0:25s    倒计时到期 (10秒)
          触发条件: 东方座位>10秒无人
                                  东 AI玩家1      倒计时重置
                                  10s开始新计时

T0:25s    【 房间已满: 4人齐 】
                                  北 玩家1
                                  西 玩家2
                                  东 AI玩家1
                                  南 你
                                  
          系统触发: 游戏开始倒计时
                                  倒计时: 10秒
          提示: "房间已满，10秒后开始"

T0:35s    倒计时到期
          所有玩家已准备
          
          【 游戏开始 】
          │ 发牌 54张
          │ 出牌顺序: 玩家1 → 玩家2 → AI → 你
          │ 进入游戏进行中
          └─────────────────→
```

**座位分配优先级** (永远遵循):

```
座位优先级表:

位置    优先级  分配规则                    坐的是谁
─────────────────────────────────────────────────
南      1      房主自动坐                  你 (房主)
北      2      第1个加入的真实玩家          玩家1
西      3      第2个加入的真实玩家          玩家2
东      4      第3个加入的真实玩家或AI      玩家3 或 AI

重要: 真实玩家优先级 > AI优先级
```

### 1.3 AI 加入的精确触发机制

```
【 AI 加入条件 - 精确触发规则 】

监控单位: 每个空座位

For each 空座位 (北/西/东):
  
  倒计时 = 该座位创建时间戳到现在的时间差
  
  If 倒计时 >= 10秒:
    If 该座位仍为空:
      Then:
        1. 调用 AI系统生成玩家
        2. 将AI分配到该座位
        3. 广播: AI_JOINED 事件
        4. 重置所有其他空座位的倒计时
        5. 检查房间是否4人齐
           If 4人齐:
             → 触发游戏开始倒计时 (10秒)
           Else:
             → 继续监控其他空座位
```

**关键特性**:

✅ **独立倒计时**: 每个座位有独立的倒计时
- 北座位创建时 T0
- 西座位创建时 T5 (当北坐了人)
- 东座位创建时 T10 (当西坐了人)

✅ **倒计时重置**: 当该座位有新玩家加入时
- 北座位: T5时玩家1加入 → 倒计时重置为0
- 西座位: T10时玩家2加入 → 倒计时重置为0
- 东座位: T15时无新玩家 → 继续计数，T25时AI加入

✅ **并行处理**: 多个座位可能同时计时
- T20时: 西座位10s, 东座位5s → AI可能随时加入东座位

---

## 第2部分: AI 机器人系统 (完整实现)

### 2.1 AI 玩家的基础属性

```
【 AI 玩家数据结构 】

AIPlayer {
  
  // 身份信息
  id: "ai_20251213_0001"         // AI唯一ID (日期+序号)
  name: "AI玩家1"                // 显示昵称
  type: "AI"                      // 玩家类型
  position: "EAST"                // 座位: NORTH/WEST/EAST/SOUTH
  
  // 显示属性 (虚拟, 仅用于UI)
  level: 12                        // 等级 8-18 (随机)
  avatar: "ai_avatar_1"           // 系统默认头像
  coins_display: 85000            // 显示金币 50k-200k (随机)
  
  // 游戏属性
  cards_hand: [...]               // 手牌数组 (27张)
  cards_played: 0                 // 已出牌次数
  cards_passed: 0                 // 已过牌次数
  is_ready: true                  // 准备状态
  status: "THINKING"              // 状态: THINKING/WAITING/IDLE
  
  // AI能力配置
  difficulty: "normal"            // 难度: simple/normal/hard
  decision_delay_ms: 1800         // 延迟 (毫秒)
  win_rate_target: 45             // 目标胜率
  
  // 时间戳
  joined_at: 1702462425000        // 加入时间
  last_action_at: 1702462425000   // 最后操作时间
  
  // AI决策缓存
  visible_cards: [...]            // 已出的卡片
  player_analysis: {              // 对手分析
    player_a: { estimated_cards: 11, style: "aggressive" },
    player_b: { estimated_cards: 13, style: "defensive" },
    player_c: { estimated_cards: 9, style: "balanced" }
  }
}
```

### 2.2 AI 玩家属性生成规则

```
【 AI 属性随机生成 】

昵称生成:
  格式: "AI玩家" + 序号
  序号: 按加入顺序 (1, 2, 3)
  示例: "AI玩家1", "AI玩家2", "AI玩家3"

等级生成 (Level):
  范围: 8-18 (11个等级)
  分布: 均匀随机
  算法: Math.floor(Math.random() * 11) + 8
  示例: Lv.10, Lv.15, Lv.8
  注: 仅用于显示, 不影响实际能力

金币生成 (Coins Display):
  范围: 50,000 - 200,000
  分布: 均匀随机
  算法: Math.floor(Math.random() * 150000) + 50000
  示例: 85,000, 120,500, 73,200
  注: 本局后重置, 不累积

头像生成 (Avatar):
  选项: 6个系统默认头像
  分布: 随机选择
  标志: [AI] 红色标签 (所有界面)
  示例: ai_avatar_1.png, ai_avatar_2.png

状态初始化:
  is_ready: true                  (AI 总是准备好)
  status: "IDLE"                  (等待轮次)
  cards_played: 0                 (未出牌)
  cards_passed: 0                 (未过牌)
```

### 2.3 AI 决策系统 (6层优先级框架)

```
【 AI 出牌决策 - 优先级系统 】

当轮到 AI 出牌时:

输入: 
  - AI 手牌 (27张)
  - 对方上一张出的牌
  - 其他玩家的手牌数量
  - 当前级数和进度

处理流程:

Step 1: 分析当前局面
  ├─ 我的手牌数量
  ├─ 对方的手牌数量
  ├─ 我的队友是否领先
  └─ 当前的出牌历史

Step 2: 评估可行的出牌方案
  ├─ 能压过对方吗?
  ├─ 如果能，有几种压法?
  ├─ 是否应该过牌保存大牌?
  └─ 列出所有可行方案

Step 3: 按优先级评分
  ├─ 优先级1: 必杀牌 (能直接赢这一轮)
  ├─ 优先级2: 得分最大的牌
  ├─ 优先级3: 守守牌 (防守策略)
  ├─ 优先级4: 配合队友
  ├─ 优先级5: 风险评估
  └─ 优先级6: 特殊场景处理

Step 4: 选择最优方案
  ├─ 对每个方案评分
  ├─ 选择分数最高的
  └─ 可能加入随机扰动 (避免太机械)

Step 5: 执行延迟
  ├─ 根据难度选择延迟范围
  ├─ 随机延迟 (1-3秒)
  └─ 显示 "AI正在思考..."

Step 6: 发送出牌
  ├─ 检查是否合法
  ├─ 广播给所有玩家
  └─ 继续游戏


【 AI 优先级详解 】

优先级1: 必杀牌 (Kill Shot)
  ├─ 定义: 能直接赢这一轮的出牌
  ├─ 例子: 对方出顺子5-9, 我有顺子7-J, 无人能压
  ├─ 决策: 如果有必杀牌，99%选择出
  ├─ 执行延迟: 较短 (0.5-1秒)
  └─ 分数: 10000分 (最高)

优先级2: 得分最大的牌 (Max Value)
  ├─ 定义: 出牌后预期收益最大
  ├─ 例子: 能压过的多张顺子中，选最大的
  ├─ 计算:
  │  ├─ 收益 = 赢这轮的概率 × 金币奖励
  │  ├─ 成本 = 损失的牌张价值
  │  └─ 得分 = 收益 - 成本
  ├─ 决策: 多个选项中选最高分的
  ├─ 执行延迟: 中等 (1-2秒)
  └─ 分数: 5000-9999分

优先级3: 守守牌 (Defense)
  ├─ 定义: 无法压过时，保存大牌
  ├─ 例子: 对方出顺子，我无法压 → 过牌保留大王
  ├─ 条件: 当优先级1和2都不适用时
  ├─ 决策:
  │  ├─ 如果手牌都是小牌 → 随意过
  │  ├─ 如果有大牌 → 保留大牌
  │  └─ 偶尔违反规则 (增加随机性)
  ├─ 执行延迟: 最短 (0.3-0.8秒)
  └─ 分数: 1000-4999分

优先级4: 配合队友 (Teamwork)
  ├─ 定义: 帮助队友赢的机会
  ├─ 例子: 对家快赢了，我压制对手助其获胜
  ├─ 条件: 队友有优势时激活
  ├─ 决策: 稍微倾向压牌而非过牌
  ├─ 权重: +500分 (加成)
  └─ 限制: 不能损害自己太多

优先级5: 风险评估 (Risk Management)
  ├─ 定义: 根据当前形势调整策略
  ├─ 指标:
  │  ├─ 手牌数量 < 6 → 激进 (更可能压)
  │  ├─ 手牌数量 6-10 → 均衡 (正常)
  │  ├─ 手牌数量 > 10 → 保守 (更可能过)
  │  └─ A级 → 超保守 (最少冒险)
  ├─ 调整: 根据风险等级调整决策分数
  └─ 权重: -1000到+1000分 (调整)

优先级6: 特殊场景 (Special Cases)
  ├─ 接风场景:
  │  ├─ AI对家出完牌 → AI获得接风
  │  ├─ 决策: 积极出牌，争取赢
  │  └─ 权重: +2000分 (加成)
  ├─ 抗贡场景:
  │  ├─ AI末游有2张大王 → 判断是否抗贡
  │  ├─ 算法: 损益分析 (抗贡收益 vs 进贡风险)
  │  └─ 决策: 保守倾向进贡, 激进倾向抗贡
  ├─ 升级场景:
  │  ├─ 打A级 → AI更加谨慎
  │  ├─ 即将升级 → 稍微激进
  │  └─ 权重: ±500分 (场景调整)
  └─ 逢人配:
     ├─ 识别逢人配 (主牌红桃)
     ├─ 灵活使用逢人配代替主牌
     └─ 权重: +300分 (加成)
```

### 2.4 AI 难度等级与胜率控制

```
【 AI 难度配置 】

Simple (简单) - 30% 概率
  ├─ 目标胜率: 30%
  ├─ 特点: 保守、易被压
  ├─ 延迟: 1-2秒
  ├─ 优点识别: 80% (容易出错)
  ├─ 配合能力: 30% (几乎不配合)
  ├─ 使用场景: 新手练习房间
  └─ 配置参数:
     {
       difficulty: "simple",
       decision_quality: 0.8,
       teamwork_factor: 0.3,
       aggression: 0.2,
       delay_range: [1000, 2000]
     }

Normal (普通/推荐) - 60% 概率
  ├─ 目标胜率: 45% (略弱于人类)
  ├─ 特点: 均衡、有竞争力
  ├─ 延迟: 1.5-3秒
  ├─ 优点识别: 95% (高准确)
  ├─ 配合能力: 60% (有基础配合)
  ├─ 使用场景: 正常房间(推荐)
  └─ 配置参数:
     {
       difficulty: "normal",
       decision_quality: 0.95,
       teamwork_factor: 0.6,
       aggression: 0.5,
       delay_range: [1500, 3000]
     }

Hard (困难) - 10% 概率
  ├─ 目标胜率: 55% (略强于人类)
  ├─ 特点: 激进、计算精准
  ├─ 延迟: 0.5-1.5秒
  ├─ 优点识别: 99% (完美准确)
  ├─ 配合能力: 90% (密切配合)
  ├─ 使用场景: 高手挑战房间(仅测试)
  └─ 配置参数:
     {
       difficulty: "hard",
       decision_quality: 0.99,
       teamwork_factor: 0.9,
       aggression: 0.8,
       delay_range: [500, 1500]
     }

胜率控制算法:
  
  每1000局统计一次:
    actual_winrate = 赢/总局数
    target_winrate = 45%
    
    If actual_winrate > target_winrate + 5%:
      → 降低decision_quality
      → 增加随机性
      → 延迟变化
    Else If actual_winrate < target_winrate - 5%:
      → 提升decision_quality
      → 减少随机性
      → 改进牌型识别
    Else:
      → 保持不变
```

### 2.5 AI 出牌的完整时序图

```
【 AI 出牌完整时间线 】

T0:00s   系统判断: 轮到AI出牌
         │ 检查: AI的状态
         │ 设置: status = "THINKING"
         │ 显示: "[AI玩家X 正在思考...]"
         │
         ├─ Web版: 玩家卡片显示思考中
         ├─ Mobile: 屏幕上显示"AI正在思考"
         └─ 声效: 无 (安静)

T0:00s   后端AI系统开始计算
         │ 获取:
         │  ├─ AI的27张手牌
         │  ├─ 对方上一张出的牌
         │  ├─ 所有玩家的手牌数量估计
         │  ├─ 已出的牌的历史记录
         │  └─ 当前级数
         │
         ├─ 第一步: 分析局面
         │  ├─ 我有27张牌
         │  ├─ 对方要压的是顺子5-9
         │  ├─ 我能压吗? (找出所有能压的组合)
         │  ├─ 结果: 有3种压法 (7-J, 8-Q, 9-K)
         │  └─ 无法压? (没有比对方更大的组合)
         │
         ├─ 第二步: 评估所有方案
         │  ├─ 方案A: 出顺子7-J
         │  │  ├─ 评分计算
         │  │  ├─ 胜率: 70%
         │  │  ├─ 损失: 5张中牌
         │  │  └─ 总分: 3500分
         │  │
         │  ├─ 方案B: 出顺子8-Q
         │  │  ├─ 胜率: 65%
         │  │  ├─ 损失: 5张大牌
         │  │  └─ 总分: 3200分
         │  │
         │  ├─ 方案C: 出顺子9-K
         │  │  ├─ 胜率: 60%
         │  │  ├─ 损失: 最大的5张牌
         │  │  └─ 总分: 2800分
         │  │
         │  └─ 方案D: 过牌 (防守)
         │     ├─ 胜率: 40% (依赖队友)
         │     ├─ 优势: 保留所有大牌
         │     └─ 总分: 1500分
         │
         ├─ 第三步: 加入难度修正
         │  ├─ 当前难度: "normal"
         │  ├─ 随机扰动: 加入-10% 的随机因子
         │  └─ 修正后:
         │     ├─ 方案A: 3150分 (最高)
         │     ├─ 方案B: 2880分
         │     ├─ 方案C: 2520分
         │     └─ 方案D: 1350分
         │
         └─ 最终决策: 选择方案A (出顺子7-J)

T0:05s   计算完成, 选择延迟时间
         │ 根据难度选择延迟:
         │  ├─ difficulty = "normal"
         │  ├─ 延迟范围: 1500-3000ms
         │  ├─ 随机延迟: 2100ms (1.5-3秒之间)
         │  └─ 目的: 仿真人思考
         │
         ├─ 等待延迟时间
         ├─ T0:05s - T0:07.1s 
         │  ├─ 显示: 继续显示"正在思考..."
         │  ├─ 进度条: 动画进度 (若有)
         │  ├─ 倒计时: 显示延迟秒数 "2.1s"
         │  └─ 声效: 无
         │
         └─ T0:07.1s 延迟时间到

T0:07.1s  执行出牌动作
         │ 验证:
         │  ├─ 是否合法? ✓ Yes
         │  ├─ 牌张是否有效? ✓ Yes
         │  └─ 符合出牌规则? ✓ Yes
         │
         ├─ 发送: PLAY_CARD 事件
         │  ├─ playerId: "ai_20251213_0001"
         │  ├─ action: "PLAY"
         │  ├─ cards: [7♠, 8♠, 9♠, 10♠, J♠]
         │  ├─ timestamp: 1702462432100
         │  └─ delay: 2100
         │
         ├─ 显示效果:
         │  ├─ 动画: 5张牌从AI的手牌飞向中央
         │  ├─ 时长: 0.5秒 (抛物线)
         │  ├─ 声效: "啪" 出牌音效
         │  └─ 显示: "[AI玩家X 出了顺子 7♠-J♠]"
         │
         ├─ 游戏状态更新:
         │  ├─ AI的手牌数: 27 - 5 = 22张
         │  ├─ AI的出牌次数: +1
         │  ├─ 中央显示的牌: [7♠, 8♠, 9♠, 10♠, J♠]
         │  └─ 当前出牌者: AI玩家
         │
         └─ 转向下一玩家

T0:08s    转向下一玩家(你)
         │ 系统判断:
         │  ├─ 现在轮到: 玩家D (你)
         │  ├─ 倒计时: 开始 30秒
         │  ├─ 状态: WAITING_YOUR_ACTION
         │  └─ 提示: "现在轮到你，请选择压牌或过牌"
         │
         ├─ 显示:
         │  ├─ Web: 你的卡片被高亮, 出牌按钮亮起
         │  ├─ Mobile: 倒计时开始, 底部按钮可点
         │  ├─ 当前牌面: 显示AI出的顺子
         │  └─ 历史记录: "AI玩家X 出了顺子"
         │
         └─ 等待你的响应 (30秒倒计时)
         
T0:09s    你选择 [过牌]
         │ 系统处理:
         │  ├─ 接收: PASS 事件
         │  ├─ 验证: 合法 ✓
         │  └─ 状态: 继续出牌权
         │
         ├─ 游戏更新:
         │  ├─ 当前出牌者: 玩家E (下一个)
         │  ├─ 已过牌列表: [你, ...]
         │  └─ 倒计时: 转向下一玩家
         │
         └─ 继续游戏... (流程循环)
```

### 2.6 AI 特殊场景处理

```
【 AI 在特殊场景中的表现 】

场景1: 接风 (AI对家出完最后一张牌)
  
  时序:
    T0:00s AI对家出完最后牌 (对2)
    T0:00s 其他玩家都过
    T0:01s 系统检测: 接风条件触发
    T0:02s 出牌权转给AI
    T0:03s 提示: "🔥 接风! AI玩家获得先手权"
    T0:05s AI立即出牌 (无延迟或很短延迟)
    T0:06s 其他玩家选择压或过
  
  AI决策:
    ├─ 知道对家已经赢了这轮
    ├─ 优先选择大牌进行攻击
    ├─ 争取让对家尽快出完所有牌
    └─ 胜率评估: 自己赢的概率大幅提升

场景2: 抗贡 (AI末游有2张大王)
  
  时序:
    T0:00s 游戏结束
    T0:01s 排名确定: AI = 末游
    T0:02s 系统检测: AI有2张大王
    T0:03s AI做决策: 是否抗贡?
    
  AI决策过程:
    ├─ 分析赢家的强度
    ├─ 计算抗贡后的优势
    ├─ 损益分析:
    │  ├─ 进贡: 失去2张大王, 赢家得力, 下局先出
    │  └─ 抗贡: 保留2张大王, 赢家先出, 自己后出 (优势)
    ├─ 算法:
    │  ├─ 如果难度=simple: 80%概率进贡
    │  ├─ 如果难度=normal: 50%概率抗贡
    │  └─ 如果难度=hard: 80%概率抗贡
    └─ 执行决策
  
  结果显示:
    If 进贡:
      "AI玩家X 进贡了对大王"
      赢家还贡小牌 (5以下)
    
    If 抗贡:
      "🚀 AI玩家X 发动抗贡!"
      赢家将在下局先出牌
      AI获得后出的优势

场景3: 升级判定
  
  AI赢家时:
    ├─ 自动计算升级类型
    ├─ 头游+二游? → 升1级
    ├─ 双下 (两个末游)? → 升3级
    ├─ 未抓人 (对方都赢)? → 不升
    └─ 自动显示升级提示
  
  AI输家时:
    ├─ 无法升级
    ├─ 但可能倒退 (A级连3失败)
    └─ 下局参与进贡/还贡
  
  A级特殊:
    ├─ AI知道"A必打"的规则
    ├─ 知道"需要同伴非末游"才能打A
    ├─ 失败3次自动倒到2级
    └─ 在A级时更加谨慎(降低胜率到30%)

场景4: 逢人配灵活使用
  
  主牌: 红桃5
  
  AI手牌中:
    ├─ 有红桃5两张 (真实)
    ├─ 其他5: 黑桃5, 梅花5, 方块5 (可代替)
    └─ AI认识: 红桃5 = 逢人配 (万能牌)
  
  出牌时:
    ├─ 需要出"五连对"
    ├─ 有: 黑♠5, 梅♣5, 方♦5, 黑♠6, 红♥6
    ├─ 能出: 5-6-7-8-9 顺子
    ├─ 但缺7/8/9
    ├─ 解决: 用红♥5作为7的代替
    ├─ 显示: 用红色标记标示逢人配的位置
    └─ 结果: 出牌成功

```

---

## 第3部分: 房间流程与UI设计

### 3.1 房间完整生命周期

```
【 房间的五个阶段 】

┌─────────────────────────────────────────────────┐
│ 第一阶段: CREATED (房间创建)                     │
├─────────────────────────────────────────────────┤
│ 时长: 0秒                                        │
│ 触发: 房主点击创建房间                           │
│ 操作:                                            │
│  1. 生成房间号 (6位数字)                        │
│  2. 房主自动坐在"南"(下方)                      │
│  3. 生成北/西/东三个空座位                      │
│  4. 初始化倒计时器 (10秒)                       │
│  5. 状态转移 → WAITING                         │
│                                                │
│ 显示: "房间已创建, 等待玩家加入..."            │
│                                                │
└─────────────────────────────────────────────────┘

       ↓

┌─────────────────────────────────────────────────┐
│ 第二阶段: WAITING (等待玩家加入)                 │
├─────────────────────────────────────────────────┤
│ 时长: 最长40秒                                  │
│ 触发: 房间创建后自动进入                        │
│                                                │
│ 子阶段A: 玩家加入 (T0:00 - T0:10)              │
│  ├─ 玩家1通过链接加入                          │
│  ├─ 系统分配座位: 北 (对家)                     │
│  ├─ 倒计时重置: 10秒                           │
│  │                                             │
│  ├─ 玩家2通过邀请加入                          │
│  ├─ 系统分配座位: 西 (对手)                     │
│  ├─ 倒计时重置: 10秒                           │
│  └─ 状态: 3人已坐, 东方空置, 倒计时进行中       │
│                                                │
│ 子阶段B: AI检查 (T0:10 - T0:25)               │
│  ├─ 东座位倒计时: 10秒                         │
│  ├─ T0:20s: 还剩5秒, 无玩家加入               │
│  ├─ T0:25s: 倒计时到期                        │
│  ├─ 触发条件: 东座位>10秒无人                  │
│  ├─ 系统调用: AI生成函数                       │
│  ├─ AI坐下: 东 (AI玩家1)                      │
│  ├─ 倒计时重置: 10秒 (为防守备用)              │
│  └─ 显示: "AI玩家已加入房间"                  │
│                                                │
│ 子阶段C: 房间满人 (T0:25+)                    │
│  ├─ 4人都坐齐: 你(南) + 玩家1(北)             │
│  │           + 玩家2(西) + AI(东)            │
│  ├─ 检测: 房间满人 = True                    │
│  ├─ 倒计时重置: 10秒 → 游戏开始倒计时         │
│  ├─ 状态转移 → STARTING                       │
│  └─ 显示: "房间已满, 10秒后开始游戏"          │
│                                                │
│ 备注: 如果房主手动[开始游戏] → 立即进入        │
│       STARTING, 跳过倒计时                     │
│                                                │
└─────────────────────────────────────────────────┘

       ↓

┌─────────────────────────────────────────────────┐
│ 第三阶段: STARTING (游戏启动准备)                │
├─────────────────────────────────────────────────┤
│ 时长: 10秒                                      │
│ 触发: 房间满人或房主手动启动                    │
│                                                │
│ 操作:                                           │
│  1. 显示: "房间已满, 10秒后开始"              │
│  2. 倒计时: 10 → 9 → 8 → ... → 1 → 0        │
│  3. AI状态: [已准备] (自动)                   │
│  4. 检查其他玩家: 是否都准备?                 │
│     ├─ 若都准备: 倒计时完成立即 PLAYING      │
│     └─ 若有未准备: 继续等待 (最多10秒)       │
│  5. 倒计时到期:                               │
│     ├─ 发牌: 54张牌分配给4人 (各27张)       │
│     ├─ 确定出牌顺序: 北 → 西 → 东 → 南      │
│     ├─ 初始化游戏状态                        │
│     └─ 状态转移 → PLAYING                    │
│                                                │
│ 显示: 倒计时进度条                             │
│                                                │
└─────────────────────────────────────────────────┘

       ↓

┌─────────────────────────────────────────────────┐
│ 第四阶段: PLAYING (游戏进行中)                   │
├─────────────────────────────────────────────────┤
│ 时长: 3-10分钟 (取决于打牌速度)                │
│ 触发: 倒计时完成后                              │
│                                                │
│ 核心流程:                                      │
│  1. 开始出牌 (按座位顺序)                      │
│  2. 循环回合:                                  │
│     ├─ 当前玩家出牌或过牌                      │
│     ├─ 记录出牌历史                            │
│     ├─ 转向下一玩家                            │
│     ├─ 倒计时 30秒 (玩家决策时间)            │
│     └─ 如果超时 → 自动过牌                    │
│  3. 一轮结束:                                  │
│     ├─ 检查: 所有其他人都过吗?               │
│     ├─ 若是: 出牌者继续出牌 (获得先手)       │
│     ├─ 若否: 判断谁压过了                     │
│     └─ 压过者继续出牌                         │
│  4. 游戏进行中特殊事件:                       │
│     ├─ 接风: 某人出完最后牌 → 对家接风      │
│     ├─ 倒计时: 显示剩余时间                   │
│     └─ 提示: 当前位置、手牌数量              │
│  5. 游戏结束条件:                             │
│     ├─ 当某人出完所有27张牌                   │
│     ├─ 排名确定: 头游 (第1个出完)            │
│     ├─ 继续: 其他人继续出牌                   │
│     ├─ 二游 (第2个出完)                      │
│     ├─ 三游 (第3个出完)                      │
│     ├─ 末游 (最后1人,还有牌)                │
│     └─ 状态转移 → ENDING                     │
│                                                │
│ AI在此阶段:                                   │
│  ├─ 轮到AI时: 1-3秒思考 → 出牌              │
│  ├─ 不轮到: 等待其他玩家出牌                 │
│  └─ 记录所有出牌信息 (用于估计对手)          │
│                                                │
└─────────────────────────────────────────────────┘

       ↓

┌─────────────────────────────────────────────────┐
│ 第五阶段: ENDING (游戏结算)                      │
├─────────────────────────────────────────────────┤
│ 时长: 5-10秒                                    │
│ 触发: 4人排名确定                              │
│                                                │
│ 自动操作:                                      │
│  1. 计算最终排名:                              │
│     ├─ 头游: 得 +80金币                       │
│     ├─ 二游: 得 +40金币                       │
│     ├─ 三游: 得 -20金币                       │
│     └─ 末游: 得 -100金币                      │
│  2. 进贡/还贡:                                 │
│     ├─ 末游进贡最大的牌给头游                 │
│     ├─ 头游还贡小牌 (<10)                    │
│     └─ 动画: 牌飞回                           │
│  3. 升级计算:                                  │
│     ├─ 若头游: 判断升1/2/3级                 │
│     ├─ 若非末游: 不升级                       │
│     └─ 升级提示: 显示新级数                   │
│  4. 显示结算页:                               │
│     ├─ 排名和金币                             │
│     ├─ 升级提示                               │
│     ├─ 游戏统计                               │
│     └─ 按钮: [再来一局] [返回大厅]           │
│  5. 玩家选择:                                  │
│     ├─ 如果都选 [再来一局]                    │
│     │  └─ 状态转移 → WAITING (新一局)       │
│     ├─ 如果有人选 [返回大厅]                 │
│     │  └─ 状态转移 → CLOSING                │
│     └─ 10秒超时无操作 → CLOSING              │
│                                                │
│ AI在此阶段:                                   │
│  ├─ AI的战绩显示 (带[AI]标签)                │
│  ├─ AI不计入排行榜                           │
│  ├─ AI的金币本局后重置                       │
│  └─ 提示: "AI战绩仅供参考"                  │
│                                                │
└─────────────────────────────────────────────────┘

       ↓

┌─────────────────────────────────────────────────┐
│ 第六阶段: CLOSING (房间关闭)                     │
├─────────────────────────────────────────────────┤
│ 时长: 1-2秒                                     │
│ 触发: 玩家选择返回大厅 OR 时间超时              │
│                                                │
│ 清理操作:                                      │
│  1. 保存游戏数据:                              │
│     ├─ 每局的战绩                             │
│     ├─ 玩家的升级信息                        │
│     ├─ AI的胜率统计                          │
│     └─ 保存到数据库                          │
│  2. 释放资源:                                  │
│     ├─ 清理游戏状态                          │
│     ├─ 断开WebSocket连接                     │
│     ├─ 释放内存                              │
│     └─ 关闭计时器                            │
│  3. 返回结果:                                  │
│     └─ 重定向到大厅页面                      │
│                                                │
│ 最终状态:                                      │
│  ├─ 房间状态: CLOSED                         │
│  ├─ 房间从列表中删除                        │
│  └─ 玩家返回大厅                             │
│                                                │
└─────────────────────────────────────────────────┘
```

### 3.2 Web 版房间等待页设计 (更新)

```
【 Web版房间等待页布局 (含AI) 】

╔═══════════════════════════════════════════════════════════╗
║ 掼蛋游戏                          房间号:123456 [复制]    ║
╠═══════════════════════════════════════════════════════════╣
║                                                           ║
║                        【 房间等待中 】                   ║
║                    倒计时: 10秒 ██████░░░░░░░░░░░░░░   ║
║                                                           ║
║    ┌─────────────────────────────────────────────────┐  ║
║    │                   北方 (对家)                    │  ║
║    │                  玩家1 (等待)                    │  ║
║    │  ┌───────────────────────────────────────────┐ │  ║
║    │  │ 头像 ▮ 玩家1昵称                          │ │  ║
║    │  │      🥇 Lv.12                           │ │  ║
║    │  │      💰 80,000                          │ │  ║
║    │  │      [等待玩家中...] 倒计时: 5秒       │ │  ║
║    │  └───────────────────────────────────────────┘ │  ║
║    │                                                 │  ║
║    └────────────────────▲─────────────────────────────┘  ║
║                         │                                ║
║    ┌────────────────────┼─────────────────────────────┐  ║
║    │                    │                             │  ║
║    │ 西方(对手)     房间信息区      东方(对手)      │  ║
║    │ 玩家2         玩家数:3/4        AI玩家1        │  ║
║    │(等待中)       底注:20×1局      (已准备)        │  ║
║    │               倒计时:10秒        [AI]          │  ║
║    │                               Lv.10           │  ║
║    │ ┌─────────────┐  ┌──────────┐  ┌─────────────┐│  ║
║    │ │ 头像        │  │          │  │ 🤖头像      ││  ║
║    │ │ 玩家2昵称   │  │          │  │ AI玩家1     ││  ║
║    │ │ 🥈 Lv.10   │  │          │  │ [已准备]    ││  ║
║    │ │ 💰 45,000  │  │          │  │ 💰 75,000   ││  ║
║    │ │ [等待中]   │  │          │  │ (虚拟)      ││  ║
║    │ └─────────────┘  └──────────┘  └─────────────┘│  ║
║    │                                                 │  ║
║    │ 南方 (你 / 房主)                               │  ║
║    │ ┌──────────────────────────────────────────────┐│  ║
║    │ │ 你的头像     你的昵称 (房主)                 ││  ║
║    │ │ 🥇 Lv.14                                   ││  ║
║    │ │ 💰 120,000                                 ││  ║
║    │ │ [确认准备] [邀请好友] [返回大厅]           ││  ║
║    │ └──────────────────────────────────────────────┘│  ║
║    │                                                 │  ║
║    └─────────────────────────────────────────────────┘  ║
║                                                           ║
║ 【 座位说明 】                                           ║
║ • 北方 (上方): 玩家1 - 你的对家 (队友)                 ║
║ • 西方 (左方): 玩家2 - 对手                            ║
║ • 东方 (右方): AI玩家1 - 由系统生成 (已标记[AI])      ║
║ • 南方 (下方): 你 - 房主                              ║
║                                                           ║
║ 【 倒计时说明 】                                        ║
║ • 全局倒计时 (10秒): 监控是否还有空座位需要填补      ║
║ • 东座位无人达10秒 → AI自动坐下                      ║
║ • 房间满人 (4人) → 游戏自动在10秒后开始           ║
║                                                           ║
║ 【 AI提示 】                                            ║
║ ✅ AI玩家已加入房间 (东方座位)                        ║
║ ℹ️  AI玩家标记为 [AI], 战绩不计入排行               ║
║ 💡 AI的金币显示为虚拟金币，本局后重置               ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
```

**座位卡片样式**:

```
【 座位卡片的三种状态 】

状态1: 真实玩家已坐下
┌──────────────────────────────┐
│ 头像  玩家昵称                │
│ 🥇 Lv.12                      │
│ 💰 80,000                     │
│ [已准备] / [等待中]           │
└──────────────────────────────┘

状态2: 空座位 (等待中)
┌──────────────────────────────┐
│ [等待玩家中...]               │
│                              │
│ 倒计时: 5秒 ████░░░░░░       │
│                              │
│ 为期10秒无玩家则AI加入       │
└──────────────────────────────┘

状态3: AI玩家 (已坐下)
┌──────────────────────────────┐
│ 🤖 [AI] AI玩家1              │
│ Lv.10                        │
│ 💰 75,000 (虚拟)             │
│ [已准备]                      │
│ (系统控制)                    │
└──────────────────────────────┘
```

### 3.3 手机版房间等待页设计 (竖屏)

```
┌────────────────────────────┐
│ ← 房间号: 123456          │ (顶部)
│ 玩家: 3/4 | 倒计时: 10秒  │
├────────────────────────────┤
│                            │
│   北方(对家)               │
│  ┌──────────────┐         │
│  │ 玩家1        │         │
│  │ Lv12 等待中  │         │
│  │ 倒计时: 5秒  │         │
│  └──────────────┘         │
│                            │
│ ┌────────┐  ┌────────┐   │
│ │ 西方   │  │ 东方   │   │
│ │ 玩家2  │  │ 🤖AI1  │   │
│ │ Lv10   │  │ Lv10   │   │
│ │ 等待中 │  │[AI]    │   │
│ │ 倒计时 │  │已准备  │   │
│ │ 5秒    │  │虚拟    │   │
│ └────────┘  └────────┘   │
│                            │
│   南方 (你/房主)           │
│  ┌──────────────┐         │
│  │ 你的头像     │         │
│  │ Lv14 房主    │         │
│  │ 120,000      │         │
│  │ [准备準备]   │         │
│  │ [邀请] [返回]│         │
│  └──────────────┘         │
│                            │
│ 底注: 20 × 1局           │
│ AI已加入(东方座位)       │
│                            │
└────────────────────────────┘
```

---

## 第4部分: 网络同步与通信协议

### 4.1 关键事件的WebSocket通信

```
【 事件: AI 加入房间 】

触发条件: 某座位倒计时 >= 10秒

Client Side (玩家): 
  └─ 无需操作 (自动发生)

Server Side (后端):
  1. 检查条件:
     ├─ 该座位确实为空? ✓
     ├─ 倒计时 >= 10秒? ✓
     └─ 房间未满? ✓
  
  2. 调用 AI 生成:
     ├─ AI ID: "ai_" + timestamp + random
     ├─ 生成属性: 名字、等级、金币
     ├─ 设置状态: is_ready = true
     └─ 保存到房间对象
  
  3. 广播事件:
     ├─ 事件名: "AI_JOINED"
     ├─ 负载:
     │  {
     │    roomId: "123456",
     │    position: "EAST",
     │    aiPlayer: {
     │      id: "ai_1702462425_001",
     │      name: "AI玩家1",
     │      level: 12,
     │      coins: 85000,
     │      avatar: "ai_1",
     │      difficulty: "normal"
     │    },
     │    timestamp: 1702462425000,
     │    totalPlayers: 4,
     │    nextAction: "CHECK_START"
     │  }
     └─ 广播给所有客户端

All Clients:
  1. 接收 AI_JOINED 事件
  2. 更新座位:
     ├─ 东座位显示 AI 卡片
     ├─ [等待玩家中...] → 消失
     ├─ AI 卡片显示 (带[AI]标签)
     └─ 倒计时: 重置或停止
  3. 显示提示:
     ├─ Toast: "🤖 AI玩家已加入房间"
     ├─ 倒计时: 如果房间满人 → 10秒后开始游戏
     └─ 声效: 可选提示音
  4. 检查房间状态:
     ├─ if 4人齐:
     │  └─ 触发: GAME_START_COUNTDOWN (10秒)
     └─ else:
        └─ 继续监控其他座位

Server 继续监控:
  ├─ if 4人齐:
  │  ├─ 更新房间状态: STARTING
  │  ├─ 启动游戏倒计时: 10秒
  │  ├─ 广播: GAME_STARTING
  │  └─ 发送倒计时信息
  └─ else:
     └─ 继续监控其他空座位
```

### 4.2 出牌事件的同步

```
【 事件: AI 出牌 】

触发: 轮到 AI 出牌

后端处理:
  1. AI 决策 (本地计算):
     ├─ 分析手牌
     ├─ 评估方案
     ├─ 选择最优出牌
     └─ 计算延迟时间
  
  2. 等待延迟:
     ├─ 实际延迟 = 决策时间 + 加成延迟
     ├─ 范围: 1-3秒
     └─ 示例: 1.8秒后
  
  3. 验证出牌合法性:
     ├─ 检查牌张有效?
     ├─ 检查牌型合法?
     ├─ 检查是否压过对方?
     └─ 全部通过 ✓
  
  4. 更新游戏状态:
     ├─ 移除 AI 的手牌
     ├─ 添加到"中央"牌面
     ├─ 记录出牌历史
     └─ 更新 AI 的统计 (出牌次数+1)
  
  5. 广播事件:
     ├─ 事件名: "CARD_PLAYED"
     ├─ 负载:
     │  {
     │    roomId: "123456",
     │    playerId: "ai_1702462425_001",
     │    playerName: "AI玩家1",
     │    action: "PLAY",
     │    cards: ["7♠", "8♠", "9♠", "10♠", "J♠"],
     │    cardType: "顺子",
     │    thinkingTime: 1800,  // 毫秒
     │    timestamp: 1702462427000,
     │    nextPlayer: "player_d"
     │  }
     └─ 发送给所有客户端

All Clients:
  1. 接收 CARD_PLAYED:
  2. 动画:
     ├─ AI 的卡片从手牌飞向中央
     ├─ 抛物线动画 (0.5秒)
     ├─ 卡片放大并旋转
     └─ 完成时播放声效
  3. 更新 UI:
     ├─ AI 的手牌数: 27 - 5 = 22
     ├─ 显示出牌内容: "AI玩家1 出了顺子"
     ├─ 中央牌面更新: 显示这5张牌
     ├─ AI 的统计: 出牌次数 +1
     └─ 历史记录: 添加此出牌
  4. 转向下一玩家:
     ├─ 高亮下一玩家
     ├─ 倒计时重置: 30秒
     └─ 等待下一玩家操作

Server 继续:
  ├─ 记录此操作到日志
  ├─ 更新房间状态
  └─ 等待下一玩家操作
```

---

## 第5部分: 故障处理与恢复

### 5.1 AI相关故障

```
【 故障1: AI 决策超时 (>5秒) 】

检测:
  if (aiThinkingTime > 5000ms):
    → 触发超时处理
  
处理:
  1. 记录日志:
     ├─ AI ID
     ├─ 手牌情况
     ├─ 思考时间
     └─ 决策内容
  
  2. 强制操作:
     ├─ 强制 AI 过牌
     ├─ 继续游戏
     └─ 生成告警 (非玩家可见)
  
  3. 提示 (可选):
     ├─ Web: 无提示 (隐形处理)
     ├─ 或显示: "AI响应延迟"
     └─ 不影响游戏进行
  
  4. 改进:
     ├─ 优化 AI 算法
     ├─ 增加服务器资源
     └─ 监控频率
  
恢复: 游戏继续进行, 转向下一玩家

【 故障2: AI 出非法牌 】

检测:
  if (cardValidation.fail):
    → 牌型识别出错
  
处理:
  1. 拒绝操作:
     ├─ 不允许此出牌
     ├─ 回滚游戏状态
     └─ 生成告警
  
  2. 强制过牌:
     ├─ 强制 AI 过牌
     ├─ 转向下一玩家
     └─ 继续游戏
  
  3. 详细日志:
     ├─ AI的手牌
     ├─ 试图出的牌
     ├─ 为什么违法
     └─ 上下文信息
  
  4. 改进:
     ├─ Debug 牌型识别
     ├─ 修复漏洞
     └─ 单元测试

恢复: 继续游戏, 转向下一玩家

【 故障3: 房间加入失败 】

检测:
  if (joinTimeout > 30s):
    → 加入失败
  
处理:
  1. 自动重试:
     ├─ 重试次数: 3次
     ├─ 间隔: 2秒
     └─ 第4次失败 → 显示错误
  
  2. 用户提示:
     ├─ "连接超时，请检查网络"
     ├─ [重试] 按钮
     ├─ [返回大厅] 按钮
     └─ 不阻止游戏
  
  3. 日志:
     ├─ 用户ID
     ├─ 房间号
     ├─ 失败原因
     └─ 错误堆栈

恢复: 玩家手动重试或返回大厅

【 故障4: AI与真人座位冲突 】

检测:
  if (座位同时收到真人和AI加入请求):
    → 冲突
  
处理:
  1. 优先级判定:
     ├─ 真人优先级 > AI优先级
     ├─ 保留真人
     ├─ 删除已分配的AI
     └─ 重新分配AI到其他座位
  
  2. 操作:
     ├─ 北座位: 真人加入
     ├─ 东座位: 删除AI (如果已分配)
     ├─ 西座位: 重新分配AI
     └─ 广播更新
  
  3. 用户体验:
     ├─ 真人: 正常加入
     ├─ AI: 无感知 (后端自动处理)
     └─ 其他玩家: 看到座位更新
  
恢复: 房间重新平衡, 继续等待
```

### 5.2 网络与同步故障

```
【 故障5: WebSocket 连接丢失 】

检测:
  if (connection.state == "DISCONNECTED"):
    → 连接丢失
  
处理:
  1. 客户端:
     ├─ 尝试重新连接 (指数退避)
     ├─ 本地缓存游戏状态
     ├─ 显示: "正在重新连接..."
     └─ 用户可继续操作 (稍后同步)
  
  2. 服务器:
     ├─ 检测玩家离线 (5秒)
     ├─ 保存游戏快照
     ├─ 玩家离线 > 60秒 → AI接替
     └─ 恢复时同步状态
  
  3. 恢复:
     ├─ 连接恢复后
     ├─ 下载最新游戏状态
     ├─ 更新本地 UI
     ├─ 继续游戏
     └─ 如果中途有AI操作 → 正常合并

【 故障6: 数据不一致 】

检测:
  if (clientState != serverState):
    → 同步错误
  
处理:
  1. 服务器是源头:
     ├─ 使用服务器数据覆盖客户端
     ├─ 刷新 UI
     └─ 生成日志
  
  2. 用户影响:
     ├─ 如果是出牌数据: 可能要重新选牌
     ├─ 如果是显示数据: 自动刷新
     └─ 如果是游戏状态: 自动恢复
  
  3. 日志:
     ├─ 客户端数据
     ├─ 服务器数据
     ├─ 差异分析
     └─ 原因追踪
  
恢复: 强制同步, 继续游戏或重新选择
```

---

## 第6部分: 监控与优化

### 6.1 AI 性能监控

```
【 实时监控指标 】

1. AI 胜率
   └─ 每日统计:
      ├─ 赢的局数
      ├─ 总局数
      ├─ 计算胜率 = 赢 / 总
      ├─ 目标: 45% ± 5%
      └─ 异常告警: > 50% 或 < 40%

2. AI 平均出牌延迟
   └─ 监控:
      ├─ 简单过牌: 应该 0.5-1.5秒
      ├─ 正常出牌: 应该 1.5-3秒
      ├─ 复杂出牌: 应该 2-3秒
      └─ 异常告警: > 5秒

3. AI 决策准确率
   └─ 检测:
      ├─ 出的牌是否合法
      ├─ 出的牌是否最优
      ├─ 目标: > 95%
      └─ 低于 90% → 需要改进

4. AI 故障率
   └─ 监控:
      ├─ 超时次数
      ├─ 非法牌次数
      ├─ 目标: < 0.1%
      └─ 高于 1% → 紧急修复

【 日志和告警 】

日志格式:
  [时间] [房间ID] [AI名字] 
  结果: [排名] 
  延迟: [平均秒数]
  
  示例:
  [2025-12-13 02:15:30] 
  房间: 123456
  AI: "AI玩家1"
  排名: 头游
  延迟: 1.8s
  决策准确: 100%
  游戏时长: 3m 45s
  
告警规则:
  ├─ 胜率异常 (>55% 或 <35%)
  ├─ 响应超时 (>5秒)
  ├─ 决策失败 (非法牌)
  ├─ 故障率高 (>1%)
  └─ 立即通知运维团队

```

---

## 第7部分: 测试清单 (生产级)

### 7.1 AI 相关测试

```
【 AI 加入测试 】

✓ TC-AI-001: AI自动加入 (10秒倒计时)
  步骤:
    1. 房主创建房间
    2. 等待10秒无人加入
    3. 验证: AI自动坐在空座位
    4. 验证: 显示 [AI] 标签
    5. 验证: 倒计时重置

✓ TC-AI-002: 多个AI顺序加入
  步骤:
    1. 房主创建 → 坐下方
    2. 第1玩家加入 → 坐北方 → 倒计时重置
    3. 等待10秒 → AI1坐西方
    4. 等待10秒 → AI2坐东方
    5. 验证: 3个座位都有AI标记

✓ TC-AI-003: 真人替换AI
  步骤:
    1. AI坐在西方座位
    2. 真人点击加入
    3. 验证: 真人优先
    4. 验证: AI被移除
    5. 验证: AI重新分配到东方

✓ TC-AI-004: AI出牌决策
  步骤:
    1. 游戏开始
    2. 轮到AI出牌
    3. 观察: AI思考延迟 (1-3秒)
    4. 验证: 出的牌合法
    5. 验证: 显示 "[AI 正在思考...]"
    6. 验证: 出牌完成并显示动画

✓ TC-AI-005: AI特殊场景 (接风)
  步骤:
    1. AI出完最后一张
    2. 验证: 接风条件触发
    3. 验证: AI对家获得先手
    4. 验证: 显示接风提示

✓ TC-AI-006: AI特殊场景 (抗贡)
  步骤:
    1. AI末游有2张大王
    2. 验证: 系统提示进贡选项
    3. 验证: AI自动判定 (进贡or抗贡)
    4. 验证: 选择正确执行

✓ TC-AI-007: AI胜率监控
  步骤:
    1. 运行1000局游戏 (含AI)
    2. 统计AI胜率
    3. 验证: 45% ± 5%
    4. 验证: 如果异常自动调整

【 座位分配测试 】

✓ TC-SEAT-001: 玩家座位分配顺序
  步骤:
    1. 房主创建 → 南 ✓
    2. 玩家1加入 → 北 ✓
    3. 玩家2加入 → 西 ✓
    4. 玩家3加入 → 东 ✓
    5. 验证: 座位分配正确

✓ TC-SEAT-002: AI座位显示
  Web版:
    ├─ 验证: [AI] 标签显示
    ├─ 验证: 坐标位置正确 (上下左右)
    ├─ 验证: 实时更新
    
  手机竖屏:
    ├─ 验证: 2×2网格显示
    ├─ 验证: 触摸反应正常
    └─ 验证: 信息完整显示

【 房间流程测试 】

✓ TC-ROOM-001: 房间创建→等待→开始
  步骤:
    1. 创建房间 → CREATED ✓
    2. 进入等待 → WAITING ✓
    3. 倒计时满 → 4人齐 ✓
    4. 游戏开始 → PLAYING ✓

✓ TC-ROOM-002: 倒计时重置
  步骤:
    1. 倒计时 8秒
    2. 玩家加入
    3. 验证: 倒计时重置为 10秒

✓ TC-ROOM-003: 房间满人自动开始
  步骤:
    1. 4人齐
    2. 等待 10秒
    3. 验证: 游戏自动开始

✓ TC-ROOM-004: 游戏结束→结算→再来一局
  步骤:
    1. 游戏完成 → ENDING
    2. 显示结算页
    3. 玩家选 [再来一局]
    4. 验证: 进入新一局 (WAITING)

【 边界测试 】

✓ TC-EDGE-001: 房间最长等待 (40秒)
  步骤:
    1. 房主创建
    2. 40秒无人加入
    3. 验证: AI逐个加入
    4. 验证: 最终4人开始

✓ TC-EDGE-002: 玩家中途断线
  步骤:
    1. 游戏进行中断线
    2. 5秒后重连
    3. 验证: 恢复游戏状态
    4. 验证: 无人员变化 (AI未接替)

✓ TC-EDGE-003: AI连续多局
  步骤:
    1. 多个AI参加多局
    2. 验证: 胜率稳定
    3. 验证: 无故障累积
    4. 验证: 内存无泄漏

```

---

## 结语

本文档 v2.1 提供了掼蛋游戏的**生产级完整需求**，包括：

✅ **座位系统** (上下左右，本人永远下方)
✅ **AI机器人系统** (10秒自动加入，6层决策优先级)
✅ **房间生命周期** (CREATED → WAITING → STARTING → PLAYING → ENDING → CLOSING)
✅ **网络同步** (WebSocket事件驱动)
✅ **故障处理** (6种故障场景及恢复方案)
✅ **监控系统** (实时胜率、延迟、准确率)
✅ **完整测试清单** (生产级验证)

**下一步**:
1. 使用 Spec Kit 分解技术任务
2. 设计 AI 决策算法的具体实现
3. 开发房间状态机
4. 实现 WebSocket 实时同步
5. 建立监控和日志系统

**预期工作量**: 8-10周全职开发 (4人团队)

---

**文档版本**: v2.1 (生产级详细)
**创建日期**: 2025年12月13日
**审核状态**: ✅ 完成，待产品/研发评审
**下一步**: 原型设计 + 技术方案评审

